name: ğŸ§ª Test Slack Bot Only

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-slack:
    name: ğŸ¤– Test Slack Bot
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ§ª Simple Slack Test
      uses: actions/github-script@v7
      with:
        script: |
          const https = require('https');
          
          console.log('ğŸ¤– æ¸¬è©¦ Slack Bot Token...');
          
          const SLACK_BOT_TOKEN = '${{ secrets.SLACK_BOT_TOKEN }}';
          const SLACK_CHANNEL = 'C09BMBKK6DN';
          
          console.log('Token å­˜åœ¨:', SLACK_BOT_TOKEN ? 'âœ… æ˜¯' : 'âŒ å¦');
          console.log('Token å‰ç¶´:', SLACK_BOT_TOKEN ? SLACK_BOT_TOKEN.substring(0, 10) + '...' : 'N/A');
          
          if (!SLACK_BOT_TOKEN) {
            console.error('âŒ SLACK_BOT_TOKEN secret æœªè¨­ç½®ï¼');
            console.log('ğŸ’¡ è«‹åœ¨ GitHub Repository Settings â†’ Secrets â†’ Actions ä¸­è¨­ç½®');
            return;
          }
          
          const testMessage = {
            channel: SLACK_CHANNEL,
            text: 'ğŸ§ª GitHub Actions Slack Bot æ¸¬è©¦æˆåŠŸï¼',
            username: 'GitHub Actions Bot',
            icon_emoji: ':github:',
            attachments: [{
              color: 'good',
              title: 'âœ… æ¸¬è©¦çµæœ',
              text: `Repository: ${{ github.repository }}\nRun: #${{ github.run_number }}\nTime: ${new Date().toISOString()}`,
              footer: 'GitHub Actions Test'
            }]
          };
          
          async function sendSlackMessage(token, message) {
            const payload = JSON.stringify(message);
            
            const options = {
              hostname: 'slack.com',
              port: 443,
              path: '/api/chat.postMessage',
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(payload)
              }
            };
            
            return new Promise((resolve) => {
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    const result = JSON.parse(data);
                    resolve({
                      status: res.statusCode,
                      success: result.ok,
                      data: result,
                      error: result.error
                    });
                  } catch (e) {
                    resolve({
                      status: res.statusCode,
                      success: false,
                      error: 'Invalid JSON response'
                    });
                  }
                });
              });
              req.on('error', (err) => resolve({ success: false, error: err.message }));
              req.write(payload);
              req.end();
            });
          }
          
          console.log('ğŸ“¤ ç™¼é€æ¸¬è©¦è¨Šæ¯...');
          
          const result = await sendSlackMessage(SLACK_BOT_TOKEN, testMessage);
          
          console.log('ğŸ“Š çµæœ:');
          console.log(`HTTP ç‹€æ…‹: ${result.status}`);
          console.log(`Slack API æˆåŠŸ: ${result.success}`);
          
          if (result.success) {
            console.log('ğŸ‰ GitHub Actions â†’ Slack æ•´åˆæˆåŠŸï¼');
            console.log(`ğŸ“± è¨Šæ¯å·²ç™¼é€åˆ° #all-ags-mpc`);
            console.log(`â° æ™‚é–“æˆ³: ${result.data.ts}`);
          } else {
            console.error('âŒ ç™¼é€å¤±æ•—:', result.error);
            console.error('è©³ç´°:', JSON.stringify(result.data, null, 2));
            
            if (result.error === 'invalid_auth') {
              console.log('ğŸ’¡ Token ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥ GitHub Secret');
            } else if (result.error === 'not_in_channel') {
              console.log('ğŸ’¡ Bot æœªè¢«é‚€è«‹åˆ° channel');
            }
            
            throw new Error(`Slack é€šçŸ¥å¤±æ•—: ${result.error}`);
          }