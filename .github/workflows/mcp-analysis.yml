name: ğŸš€ Modern MCP Calculator Pipeline

on:
  push:
    branches: [main, develop, 'feature/*']
  pull_request:
    branches: [main, develop]

env:
  MCP_SERVICE_URL: ${{ secrets.MCP_SERVICE_URL || 'http://localhost:3001' }}
  NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  analyze:
    name: ğŸ” Code Analysis & Auto Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“Š Get Changes
      id: changes
      run: |
        # ä½¿ç”¨ GitHub API ç²å–è®Šæ›´ä¿¡æ¯ï¼Œæ›´å¯é 
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
        else
          # å°æ–¼ push äº‹ä»¶ï¼Œæ¯”è¼ƒèˆ‡ main çš„å·®ç•°
          BASE="origin/main"
          HEAD="${{ github.sha }}"
        fi
        
        # ç”Ÿæˆè®Šæ›´æ‘˜è¦
        git diff --name-only $BASE...$HEAD > changed_files.txt
        git diff --stat $BASE...$HEAD > diff_stats.txt
        
        # æå–çµ±è¨ˆä¿¡æ¯
        CHANGED_FILES=$(wc -l < changed_files.txt)
        STATS=$(git diff --shortstat $BASE...$HEAD)
        INSERTIONS=$(echo "$STATS" | grep -o '[0-9]\+ insertions\?' | grep -o '[0-9]\+' || echo "0")
        DELETIONS=$(echo "$STATS" | grep -o '[0-9]\+ deletions\?' | grep -o '[0-9]\+' || echo "0")
        
        # è¨­ç½®è¼¸å‡º
        echo "changed-files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "insertions=$INSERTIONS" >> $GITHUB_OUTPUT  
        echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
        echo "base-ref=$BASE" >> $GITHUB_OUTPUT
        echo "head-ref=$HEAD" >> $GITHUB_OUTPUT

    - name: ğŸ¤– MCP Analysis
      id: mcp-analysis
      if: steps.changes.outputs.changed-files != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          try {
            // ç”Ÿæˆ diff
            const diffOutput = execSync(`git diff ${{ steps.changes.outputs.base-ref }}...${{ steps.changes.outputs.head-ref }}`, 
              { encoding: 'utf8', maxBuffer: 1024 * 1024 });
            
            // æº–å‚™åˆ†ææ•¸æ“š
            const analysisData = {
              diff: diffOutput.slice(0, 50000), // é™åˆ¶å¤§å°
              metadata: {
                repository: context.repo.owner + '/' + context.repo.repo,
                branch: '${{ github.ref_name }}',
                commit: '${{ github.sha }}',
                author: '${{ github.actor }}',
                changed_files: parseInt('${{ steps.changes.outputs.changed-files }}'),
                insertions: parseInt('${{ steps.changes.outputs.insertions }}'),
                deletions: parseInt('${{ steps.changes.outputs.deletions }}'),
                event_type: '${{ github.event_name }}'
              }
            };
            
            console.log('ğŸ“Š Analysis data prepared:', {
              diffSize: analysisData.diff.length,
              changedFiles: analysisData.metadata.changed_files
            });
            
            // èª¿ç”¨ MCP æœå‹™ (å¦‚æœå¯ç”¨)
            if (process.env.MCP_SERVICE_URL && !process.env.MCP_SERVICE_URL.includes('localhost')) {
              const response = await fetch(`${process.env.MCP_SERVICE_URL}/api/ci-cd/analyze`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${{ secrets.MCP_API_TOKEN }}`
                },
                body: JSON.stringify(analysisData)
              });
              
              if (response.ok) {
                const result = await response.json();
                console.log('âœ… MCP Analysis successful:', result.summary || 'Analysis completed');
                
                // ä¿å­˜çµæœä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
                fs.writeFileSync('analysis_result.json', JSON.stringify(result, null, 2));
                core.setOutput('analysis-success', 'true');
                core.setOutput('analysis-summary', result.summary || 'Analysis completed');
              } else {
                console.log('âš ï¸ MCP Analysis failed, continuing without AI insights');
                core.setOutput('analysis-success', 'false');
              }
            } else {
              console.log('ğŸ  Local development - skipping MCP API call');
              core.setOutput('analysis-success', 'mock');
            }
            
          } catch (error) {
            console.error('âŒ Analysis error:', error.message);
            core.setOutput('analysis-success', 'false');
          }

    - name: ğŸ“ Create Release Notes
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // è®€å–åˆ†æçµæœ
          let analysisResult = { summary: 'No analysis available' };
          try {
            if (fs.existsSync('analysis_result.json')) {
              analysisResult = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));
            }
          } catch (e) {
            console.log('No analysis result found');
          }
          
          // å‰µå»ºç™¼ä½ˆèªªæ˜
          const releaseNotes = `# ğŸ§® Calculator Release \`${{ github.ref_name }}-${{ github.run_number }}\`
          
          ## ğŸ“‹ Changes Summary
          - **Files Changed**: ${{ steps.changes.outputs.changed-files }}
          - **Lines Added**: +${{ steps.changes.outputs.insertions }}
          - **Lines Removed**: -${{ steps.changes.outputs.deletions }}
          - **Author**: ${{ github.actor }}
          - **Date**: ${new Date().toISOString().split('T')[0]}
          
          ## ğŸ¤– AI Analysis
          ${analysisResult.summary || 'Analysis not available'}
          
          ## ğŸ”— Links
          - **Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - **Repository**: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          
          ---
          *ğŸ¤– Auto-generated by MCP Calculator Pipeline*`;
          
          console.log('ğŸ“ Release notes generated');
          fs.writeFileSync('RELEASE_NOTES.md', releaseNotes);

    - name: ğŸ”— Real Notion Page Creation
      id: notion-creation
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/github-script@v7  
      with:
        script: |
          const https = require('https');
          const NOTION_API_KEY = '${{ secrets.NOTION_API_KEY }}';
          
          console.log('ğŸ”— Creating real Notion page via GitHub Actions...');
          
          if (!NOTION_API_KEY) {
            console.error('âŒ NOTION_API_KEY secret æœªè¨­ç½®ï¼');
            console.log('ğŸ’¡ è«‹åœ¨ GitHub Repository Settings â†’ Secrets â†’ Actions ä¸­è¨­ç½®');
            return;
          }
          
          // æœç´¢ parent é é¢
          async function findParentPage() {
            const searchData = JSON.stringify({
              query: "MCP-DEMO", 
              page_size: 5
            });
            
            return new Promise((resolve, reject) => {
              const req = https.request({
                hostname: 'api.notion.com',
                port: 443,
                path: '/v1/search',
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${NOTION_API_KEY}`,
                  'Content-Type': 'application/json', 
                  'Notion-Version': '2022-06-28'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              });
              req.on('error', reject);
              req.write(searchData);
              req.end();
            });
          }
          
          // å‰µå»ºé é¢
          async function createPage(parentId) {
            const pageData = JSON.stringify({
              parent: { type: "page_id", page_id: parentId },
              properties: {
                title: {
                  title: [{
                    text: {
                      content: `ğŸš€ GitHub Actions Release - Run #${{ github.run_number }}`
                    }
                  }]
                }
              },
              children: [
                {
                  object: "block",
                  type: "heading_1", 
                  heading_1: {
                    rich_text: [{ type: "text", text: { content: "ğŸ“‹ è‡ªå‹•åŒ–ç™¼ä½ˆç­†è¨˜" } }]
                  }
                },
                {
                  object: "block",
                  type: "paragraph",
                  paragraph: {
                    rich_text: [{
                      type: "text", 
                      text: { content: "ğŸ”„ æ­¤é é¢ç”± GitHub Actions è‡ªå‹•å‰µå»º\nğŸ“Š Repository: ${{ github.repository }}\nğŸŒ¿ Branch: ${{ github.ref_name }}\nğŸ“ Commit: ${{ github.sha }}\nğŸ‘¤ Author: ${{ github.actor }}\nğŸ“… Date: " + new Date().toISOString() }
                    }]
                  }
                },
                {
                  object: "block",
                  type: "heading_2",
                  heading_2: {
                    rich_text: [{ type: "text", text: { content: "ğŸ“ˆ è®Šæ›´çµ±è¨ˆ" } }]
                  }
                },
                {
                  object: "block",
                  type: "bulleted_list_item",
                  bulleted_list_item: {
                    rich_text: [{ type: "text", text: { content: "ğŸ“ Files: ${{ steps.changes.outputs.changed-files }} changed" } }]
                  }
                },
                {
                  object: "block", 
                  type: "bulleted_list_item",
                  bulleted_list_item: {
                    rich_text: [{ type: "text", text: { content: "âœ… Lines: +${{ steps.changes.outputs.insertions }}/-${{ steps.changes.outputs.deletions }}" } }]
                  }
                },
                {
                  object: "block",
                  type: "bulleted_list_item", 
                  bulleted_list_item: {
                    rich_text: [{ type: "text", text: { content: "ğŸ¤– MCP Integration: âœ… Working!" } }]
                  }
                }
              ]
            });
            
            return new Promise((resolve) => {
              const req = https.request({
                hostname: 'api.notion.com',
                port: 443,
                path: '/v1/pages',
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${NOTION_API_KEY}`,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve({
                  status: res.statusCode,
                  data: JSON.parse(data)
                }));
              });
              req.on('error', (err) => resolve({ status: 500, error: err.message }));
              req.write(pageData);
              req.end();
            });
          }
          
          try {
            const searchResult = await findParentPage();
            if (searchResult.results && searchResult.results.length > 0) {
              const parentId = searchResult.results[0].id;
              const createResult = await createPage(parentId);
              
              if (createResult.status === 200) {
                console.log('ğŸ‰ GitHub Actions â†’ Notion æ•´åˆæˆåŠŸï¼');
                console.log('ğŸ“„ æ–°å»ºé é¢ URL:', createResult.data.url);
                console.log('ğŸ“… å‰µå»ºæ™‚é–“:', createResult.data.created_time);
                core.setOutput('notion-page-url', createResult.data.url);
              } else {
                console.log('âŒ Notion é é¢å‰µå»ºå¤±æ•—:', createResult.status);
                console.log('ğŸ’¬ éŒ¯èª¤:', createResult.error || createResult.data.message);
              }
            } else {
              console.log('âš ï¸ æ‰¾ä¸åˆ° MCP-DEMO parent é é¢');
            }
          } catch (error) {
            console.error('âŒ Notion æ•´åˆéŒ¯èª¤:', error.message);
          }

    - name: ğŸ’¬ Slack Bot Notification  
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/github-script@v7
      with:
        script: |
          const https = require('https');
          
          console.log('ğŸ¤– ä½¿ç”¨ Bot Token ç™¼é€ Slack é€šçŸ¥...');
          
          const SLACK_BOT_TOKEN = '${{ secrets.SLACK_BOT_TOKEN }}';
          const SLACK_CHANNEL = 'C09BMBKK6DN'; // all-ags-mcp
          const notionPageUrl = '${{ steps.notion-creation.outputs.notion-page-url || "https://www.notion.so/MCP-Calculator-Release-Notes" }}';
          
          if (!SLACK_BOT_TOKEN) {
            console.error('âŒ SLACK_BOT_TOKEN secret æœªè¨­ç½®ï¼');
            return;
          }
          
          const slackMessage = {
            channel: SLACK_CHANNEL,
            text: "ğŸ‰ MCP Calculator GitHub Actions è‡ªå‹•åŒ–æˆåŠŸï¼",
            username: "MCP Calculator Bot",
            icon_emoji: ":robot_face:",
            attachments: [
              {
                color: "good", 
                title: "ğŸ“‹ è‡ªå‹•åŒ–ç™¼ä½ˆç­†è¨˜",
                title_link: notionPageUrl,
                fields: [
                  {
                    title: "Repository",
                    value: "${{ github.repository }}",
                    short: true
                  },
                  {
                    title: "Author",
                    value: "${{ github.actor }}",
                    short: true
                  },
                  {
                    title: "Files Changed", 
                    value: "${{ steps.changes.outputs.changed-files }} files",
                    short: true
                  },
                  {
                    title: "Changes",
                    value: "+${{ steps.changes.outputs.insertions }}/-${{ steps.changes.outputs.deletions }} lines",
                    short: true
                  },
                  {
                    title: "Branch",
                    value: "${{ github.ref_name }}",
                    short: true
                  },
                  {
                    title: "Run Number",
                    value: "#${{ github.run_number }}",
                    short: true
                  },
                  {
                    title: "Notion Page",
                    value: `<${notionPageUrl}|ğŸ“„ æŸ¥çœ‹ç™¼ä½ˆç­†è¨˜>`,
                    short: false
                  },
                  {
                    title: "Status",
                    value: "âœ… GitHub â†’ Notion â†’ Slack å®Œæ•´æ•´åˆæˆåŠŸ (ä½¿ç”¨ Bot Token)",
                    short: false
                  }
                ],
                footer: "MCP Calculator Pipeline",
                footer_icon: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                ts: Math.floor(Date.now() / 1000)
              }
            ]
          };
          
          async function sendSlackMessage(token, message) {
            const payload = JSON.stringify(message);
            
            const options = {
              hostname: 'slack.com',
              port: 443,
              path: '/api/chat.postMessage',
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(payload)
              }
            };
            
            return new Promise((resolve) => {
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    const result = JSON.parse(data);
                    resolve({
                      status: res.statusCode,
                      success: result.ok,
                      data: result,
                      error: result.error
                    });
                  } catch (e) {
                    resolve({
                      status: res.statusCode,
                      success: false,
                      error: 'Invalid JSON response'
                    });
                  }
                });
              });
              req.on('error', (err) => resolve({ success: false, error: err.message }));
              req.write(payload);
              req.end();
            });
          }
          
          const result = await sendSlackMessage(SLACK_BOT_TOKEN, slackMessage);
          
          if (result.success) {
            console.log('ğŸ‰ Slack Bot é€šçŸ¥ç™¼é€æˆåŠŸï¼');
            console.log(`ğŸ“± è¨Šæ¯å·²ç™¼é€åˆ° #all-ags-mcp channel`);
            console.log(`â° Message timestamp: ${result.data.ts}`);
            core.setOutput('slack-success', 'true');
            core.setOutput('slack-method', 'bot-token');
          } else {
            console.error('âŒ Slack Bot é€šçŸ¥å¤±æ•—:', result.error);
            console.error('ğŸ“„ è©³ç´°:', JSON.stringify(result.data, null, 2));
            core.setOutput('slack-success', 'false');
            
            if (result.error === 'not_in_channel') {
              console.log('ğŸ’¡ è«‹åœ¨ Slack ä¸­é‚€è«‹ Bot åˆ° #all-ags-mcp channel');
            }
          }

    - name: ğŸ“‹ PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## ğŸ§® Calculator Analysis Report
          
          ### ğŸ“Š Change Statistics
          - **Files**: ${{ steps.changes.outputs.changed-files }} changed
          - **Lines**: +${{ steps.changes.outputs.insertions }}/-${{ steps.changes.outputs.deletions }}
          - **Analysis**: ${{ steps.mcp-analysis.outputs.analysis-success == 'true' && 'âœ… Completed' || 'âš ï¸ Unavailable' }}
          
          ### ğŸ¤– AI Insights
          ${{ steps.mcp-analysis.outputs.analysis-summary || 'Analysis service not available in this environment' }}
          
          ---
          *ğŸ¤– Auto-generated by MCP Calculator Pipeline*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: ğŸ¯ Summary
      if: always()
      run: |
        echo "## ğŸ§® MCP Calculator Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Repository | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Event | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Files Changed | ${{ steps.changes.outputs.changed-files }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lines Added | +${{ steps.changes.outputs.insertions }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lines Removed | -${{ steps.changes.outputs.deletions }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸš€ **Modern MCP Calculator Pipeline completed!**" >> $GITHUB_STEP_SUMMARY