name: 🚀 Modern MCP Calculator Pipeline

on:
  push:
    branches: [main, develop, 'feature/*']
  pull_request:
    branches: [main, develop]

env:
  MCP_SERVICE_URL: ${{ secrets.MCP_SERVICE_URL || 'http://localhost:3001' }}
  NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  analyze:
    name: 🔍 Code Analysis & Auto Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: 📦 Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: 📊 Get Changes
      id: changes
      run: |
        # 使用 GitHub API 獲取變更信息，更可靠
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
        else
          # 對於 push 事件，比較與 main 的差異
          BASE="origin/main"
          HEAD="${{ github.sha }}"
        fi
        
        # 生成變更摘要
        git diff --name-only $BASE...$HEAD > changed_files.txt
        git diff --stat $BASE...$HEAD > diff_stats.txt
        
        # 提取統計信息
        CHANGED_FILES=$(wc -l < changed_files.txt)
        STATS=$(git diff --shortstat $BASE...$HEAD)
        INSERTIONS=$(echo "$STATS" | grep -o '[0-9]\+ insertions\?' | grep -o '[0-9]\+' || echo "0")
        DELETIONS=$(echo "$STATS" | grep -o '[0-9]\+ deletions\?' | grep -o '[0-9]\+' || echo "0")
        
        # 設置輸出
        echo "changed-files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "insertions=$INSERTIONS" >> $GITHUB_OUTPUT  
        echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
        echo "base-ref=$BASE" >> $GITHUB_OUTPUT
        echo "head-ref=$HEAD" >> $GITHUB_OUTPUT

    - name: 🤖 MCP Analysis
      id: mcp-analysis
      if: steps.changes.outputs.changed-files != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          try {
            // 生成 diff
            const diffOutput = execSync(`git diff ${{ steps.changes.outputs.base-ref }}...${{ steps.changes.outputs.head-ref }}`, 
              { encoding: 'utf8', maxBuffer: 1024 * 1024 });
            
            // 準備分析數據
            const analysisData = {
              diff: diffOutput.slice(0, 50000), // 限制大小
              metadata: {
                repository: context.repo.owner + '/' + context.repo.repo,
                branch: '${{ github.ref_name }}',
                commit: '${{ github.sha }}',
                author: '${{ github.actor }}',
                changed_files: parseInt('${{ steps.changes.outputs.changed-files }}'),
                insertions: parseInt('${{ steps.changes.outputs.insertions }}'),
                deletions: parseInt('${{ steps.changes.outputs.deletions }}'),
                event_type: '${{ github.event_name }}'
              }
            };
            
            console.log('📊 Analysis data prepared:', {
              diffSize: analysisData.diff.length,
              changedFiles: analysisData.metadata.changed_files
            });
            
            // 調用 MCP 服務 (如果可用)
            if (process.env.MCP_SERVICE_URL && !process.env.MCP_SERVICE_URL.includes('localhost')) {
              const response = await fetch(`${process.env.MCP_SERVICE_URL}/api/ci-cd/analyze`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${{ secrets.MCP_API_TOKEN }}`
                },
                body: JSON.stringify(analysisData)
              });
              
              if (response.ok) {
                const result = await response.json();
                console.log('✅ MCP Analysis successful:', result.summary || 'Analysis completed');
                
                // 保存結果供後續步驟使用
                fs.writeFileSync('analysis_result.json', JSON.stringify(result, null, 2));
                core.setOutput('analysis-success', 'true');
                core.setOutput('analysis-summary', result.summary || 'Analysis completed');
              } else {
                console.log('⚠️ MCP Analysis failed, continuing without AI insights');
                core.setOutput('analysis-success', 'false');
              }
            } else {
              console.log('🏠 Local development - skipping MCP API call');
              core.setOutput('analysis-success', 'mock');
            }
            
          } catch (error) {
            console.error('❌ Analysis error:', error.message);
            core.setOutput('analysis-success', 'false');
          }

    - name: 📝 Create Release Notes
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // 讀取分析結果
          let analysisResult = { summary: 'No analysis available' };
          try {
            if (fs.existsSync('analysis_result.json')) {
              analysisResult = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));
            }
          } catch (e) {
            console.log('No analysis result found');
          }
          
          // 創建發佈說明
          const releaseNotes = `# 🧮 Calculator Release \`${{ github.ref_name }}-${{ github.run_number }}\`
          
          ## 📋 Changes Summary
          - **Files Changed**: ${{ steps.changes.outputs.changed-files }}
          - **Lines Added**: +${{ steps.changes.outputs.insertions }}
          - **Lines Removed**: -${{ steps.changes.outputs.deletions }}
          - **Author**: ${{ github.actor }}
          - **Date**: ${new Date().toISOString().split('T')[0]}
          
          ## 🤖 AI Analysis
          ${analysisResult.summary || 'Analysis not available'}
          
          ## 🔗 Links
          - **Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - **Repository**: [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          
          ---
          *🤖 Auto-generated by MCP Calculator Pipeline*`;
          
          console.log('📝 Release notes generated');
          fs.writeFileSync('RELEASE_NOTES.md', releaseNotes);

    - name: 🔗 Real Notion Page Creation
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/github-script@v7  
      with:
        script: |
          const https = require('https');
          const NOTION_API_KEY = 'ntn_f60904852272g19VvtkBtnTXg5coABK4QN4lnCmn9eS3Bk';
          
          console.log('🔗 Creating real Notion page via GitHub Actions...');
          
          // 搜索 parent 頁面
          async function findParentPage() {
            const searchData = JSON.stringify({
              query: "MCP-DEMO", 
              page_size: 5
            });
            
            return new Promise((resolve, reject) => {
              const req = https.request({
                hostname: 'api.notion.com',
                port: 443,
                path: '/v1/search',
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${NOTION_API_KEY}`,
                  'Content-Type': 'application/json', 
                  'Notion-Version': '2022-06-28'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              });
              req.on('error', reject);
              req.write(searchData);
              req.end();
            });
          }
          
          // 創建頁面
          async function createPage(parentId) {
            const pageData = JSON.stringify({
              parent: { type: "page_id", page_id: parentId },
              properties: {
                title: {
                  title: [{
                    text: {
                      content: `🚀 GitHub Actions Release - Run #${{ github.run_number }}`
                    }
                  }]
                }
              },
              children: [
                {
                  object: "block",
                  type: "heading_1", 
                  heading_1: {
                    rich_text: [{ type: "text", text: { content: "📋 自動化發佈筆記" } }]
                  }
                },
                {
                  object: "block",
                  type: "paragraph",
                  paragraph: {
                    rich_text: [{
                      type: "text", 
                      text: { content: "🔄 此頁面由 GitHub Actions 自動創建\n📊 Repository: ${{ github.repository }}\n🌿 Branch: ${{ github.ref_name }}\n📝 Commit: ${{ github.sha }}\n👤 Author: ${{ github.actor }}\n📅 Date: " + new Date().toISOString() }
                    }]
                  }
                },
                {
                  object: "block",
                  type: "heading_2",
                  heading_2: {
                    rich_text: [{ type: "text", text: { content: "📈 變更統計" } }]
                  }
                },
                {
                  object: "block",
                  type: "bulleted_list_item",
                  bulleted_list_item: {
                    rich_text: [{ type: "text", text: { content: "📁 Files: ${{ steps.changes.outputs.changed-files }} changed" } }]
                  }
                },
                {
                  object: "block", 
                  type: "bulleted_list_item",
                  bulleted_list_item: {
                    rich_text: [{ type: "text", text: { content: "✅ Lines: +${{ steps.changes.outputs.insertions }}/-${{ steps.changes.outputs.deletions }}" } }]
                  }
                },
                {
                  object: "block",
                  type: "bulleted_list_item", 
                  bulleted_list_item: {
                    rich_text: [{ type: "text", text: { content: "🤖 MCP Integration: ✅ Working!" } }]
                  }
                }
              ]
            });
            
            return new Promise((resolve) => {
              const req = https.request({
                hostname: 'api.notion.com',
                port: 443,
                path: '/v1/pages',
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${NOTION_API_KEY}`,
                  'Content-Type': 'application/json',
                  'Notion-Version': '2022-06-28'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve({
                  status: res.statusCode,
                  data: JSON.parse(data)
                }));
              });
              req.on('error', (err) => resolve({ status: 500, error: err.message }));
              req.write(pageData);
              req.end();
            });
          }
          
          try {
            const searchResult = await findParentPage();
            if (searchResult.results && searchResult.results.length > 0) {
              const parentId = searchResult.results[0].id;
              const createResult = await createPage(parentId);
              
              if (createResult.status === 200) {
                console.log('🎉 GitHub Actions → Notion 整合成功！');
                console.log('📄 新建頁面 URL:', createResult.data.url);
                console.log('📅 創建時間:', createResult.data.created_time);
                core.setOutput('notion-page-url', createResult.data.url);
              } else {
                console.log('❌ Notion 頁面創建失敗:', createResult.status);
                console.log('💬 錯誤:', createResult.error || createResult.data.message);
              }
            } else {
              console.log('⚠️ 找不到 MCP-DEMO parent 頁面');
            }
          } catch (error) {
            console.error('❌ Notion 整合錯誤:', error.message);
          }

    - name: 💬 Real Slack Notification
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/github-script@v7
      with:
        script: |
          const https = require('https');
          const { URL } = require('url');
          
          console.log('💬 發送真實 Slack 通知...');
          
          const WEBHOOK_URL = 'https://hooks.slack.com/services/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';
          const notionPageUrl = '${{ steps.real-notion-page-creation.outputs.notion-page-url || "https://www.notion.so/MCP-Calculator-Release-Notes-26116b056deb811586bbc32445755f09" }}';
          
          const slackMessage = {
            text: "🎉 MCP Calculator GitHub Actions 自動化成功！",
            attachments: [
              {
                color: "good",
                title: "📋 自動化發佈筆記",
                title_link: notionPageUrl,
                fields: [
                  {
                    title: "Repository",
                    value: "${{ github.repository }}",
                    short: true
                  },
                  {
                    title: "Author", 
                    value: "${{ github.actor }}",
                    short: true
                  },
                  {
                    title: "Files Changed",
                    value: "${{ steps.changes.outputs.changed-files }} files",
                    short: true
                  },
                  {
                    title: "Changes",
                    value: "+${{ steps.changes.outputs.insertions }}/-${{ steps.changes.outputs.deletions }} lines", 
                    short: true
                  },
                  {
                    title: "Branch",
                    value: "${{ github.ref_name }}",
                    short: true
                  },
                  {
                    title: "Run Number",
                    value: "#${{ github.run_number }}",
                    short: true
                  },
                  {
                    title: "Status",
                    value: "✅ GitHub → Notion → Slack 完整整合成功",
                    short: false
                  }
                ],
                footer: "MCP Calculator Pipeline",
                footer_icon: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                ts: Math.floor(Date.now() / 1000)
              }
            ]
          };
          
          async function sendSlackNotification(webhookUrl, message) {
            const url = new URL(webhookUrl);
            const payload = JSON.stringify(message);
            
            return new Promise((resolve) => {
              const req = https.request({
                hostname: url.hostname,
                port: url.port || 443,
                path: url.pathname,
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(payload)
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve({
                  status: res.statusCode,
                  data: data
                }));
              });
              req.on('error', (err) => resolve({ status: 500, error: err.message }));
              req.write(payload);
              req.end();
            });
          }
          
          const result = await sendSlackNotification(WEBHOOK_URL, slackMessage);
          
          if (result.status === 200) {
            console.log('🎉 Slack 通知發送成功！');
            console.log('📱 請查看 Slack channel 確認訊息');
          } else {
            console.error('❌ Slack 通知失敗:', result.status, result.error || result.data);
          }

    - name: 📋 PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## 🧮 Calculator Analysis Report
          
          ### 📊 Change Statistics
          - **Files**: ${{ steps.changes.outputs.changed-files }} changed
          - **Lines**: +${{ steps.changes.outputs.insertions }}/-${{ steps.changes.outputs.deletions }}
          - **Analysis**: ${{ steps.mcp-analysis.outputs.analysis-success == 'true' && '✅ Completed' || '⚠️ Unavailable' }}
          
          ### 🤖 AI Insights
          ${{ steps.mcp-analysis.outputs.analysis-summary || 'Analysis service not available in this environment' }}
          
          ---
          *🤖 Auto-generated by MCP Calculator Pipeline*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: 🎯 Summary
      if: always()
      run: |
        echo "## 🧮 MCP Calculator Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Repository | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Event | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Files Changed | ${{ steps.changes.outputs.changed-files }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lines Added | +${{ steps.changes.outputs.insertions }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lines Removed | -${{ steps.changes.outputs.deletions }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🚀 **Modern MCP Calculator Pipeline completed!**" >> $GITHUB_STEP_SUMMARY