name: 🎯 Simple MCP Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  mcp-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: 🔍 Analyze Changes
        id: analyze
        run: |
          # 簡單的變更分析
          CHANGED_FILES=$(git diff --name-only HEAD~1 | wc -l)
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          
          # 如果有變更，輸出基本信息
          if [ $CHANGED_FILES -gt 0 ]; then
            echo "📊 Found $CHANGED_FILES changed files"
            git diff --stat HEAD~1
          fi

      - name: 📝 Create Simple Notion Note
        if: github.event_name == 'push' && steps.analyze.outputs.changed_files != '0'
        run: |
          # 創建簡單的發佈筆記 (本地版本)
          cat > release-note.md << EOF
          # Calculator Update - $(date +%Y-%m-%d)
          
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Author:** ${{ github.actor }}
          
          ## Changes
          - Files changed: ${{ steps.analyze.outputs.changed_files }}
          - Commit: ${{ steps.analyze.outputs.commit_message }}
          
          ## Details
          $(git show --stat ${{ github.sha }})
          
          ---
          Auto-generated by Simple MCP Pipeline
          EOF
          
          echo "📝 Release note created:"
          cat release-note.md

      - name: 💬 Simple Slack Notification
        if: github.event_name == 'push' && env.SLACK_WEBHOOK_URL != ''
        run: |
          # 發送簡單的 Slack 消息
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"🧮 Calculator updated!\",
              \"attachments\": [{
                \"color\": \"good\",
                \"text\": \"${{ steps.analyze.outputs.commit_message }}\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Author\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"Files\", \"value\": \"${{ steps.analyze.outputs.changed_files }}\", \"short\": true}
                ]
              }]
            }" || echo "Slack notification skipped"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: 🎯 Summary
        run: |
          echo "✅ Simple MCP integration completed"
          echo "📊 Processed ${{ steps.analyze.outputs.changed_files }} changed files"