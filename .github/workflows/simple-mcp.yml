name: ðŸŽ¯ Simple MCP Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  mcp-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: ðŸ” Analyze Changes
        id: analyze
        run: |
          # ç°¡å–®çš„è®Šæ›´åˆ†æž
          CHANGED_FILES=$(git diff --name-only HEAD~1 | wc -l)
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          
          # å¦‚æžœæœ‰è®Šæ›´ï¼Œè¼¸å‡ºåŸºæœ¬ä¿¡æ¯
          if [ $CHANGED_FILES -gt 0 ]; then
            echo "ðŸ“Š Found $CHANGED_FILES changed files"
            git diff --stat HEAD~1
          fi

      - name: ðŸ“ Create Simple Notion Note
        if: github.event_name == 'push' && steps.analyze.outputs.changed_files != '0'
        run: |
          # å‰µå»ºç°¡å–®çš„ç™¼ä½ˆç­†è¨˜ (æœ¬åœ°ç‰ˆæœ¬)
          cat > release-note.md << EOF
          # Calculator Update - $(date +%Y-%m-%d)
          
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Author:** ${{ github.actor }}
          
          ## Changes
          - Files changed: ${{ steps.analyze.outputs.changed_files }}
          - Commit: ${{ steps.analyze.outputs.commit_message }}
          
          ## Details
          $(git show --stat ${{ github.sha }})
          
          ---
          Auto-generated by Simple MCP Pipeline
          EOF
          
          echo "ðŸ“ Release note created:"
          cat release-note.md

      - name: ðŸ’¬ Simple Slack Notification
        if: github.event_name == 'push' && env.SLACK_WEBHOOK_URL != ''
        run: |
          # ç™¼é€ç°¡å–®çš„ Slack æ¶ˆæ¯
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ðŸ§® Calculator updated!\",
              \"attachments\": [{
                \"color\": \"good\",
                \"text\": \"${{ steps.analyze.outputs.commit_message }}\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Author\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"Files\", \"value\": \"${{ steps.analyze.outputs.changed_files }}\", \"short\": true}
                ]
              }]
            }" || echo "Slack notification skipped"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ðŸŽ¯ Summary
        run: |
          echo "âœ… Simple MCP integration completed"
          echo "ðŸ“Š Processed ${{ steps.analyze.outputs.changed_files }} changed files"